{"ast":null,"code":"import { createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, withCtx as _withCtx, createVNode as _createVNode, renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, createBlock as _createBlock, createCommentVNode as _createCommentVNode, normalizeClass as _normalizeClass, resolveDirective as _resolveDirective, withDirectives as _withDirectives, withKeys as _withKeys } from \"vue\";\nconst _hoisted_1 = {\n  class: \"main-content\"\n};\nconst _hoisted_2 = {\n  class: \"message-page\"\n};\nconst _hoisted_3 = {\n  class: \"chat-list\"\n};\nconst _hoisted_4 = [\"onClick\"];\nconst _hoisted_5 = {\n  class: \"chat-info\"\n};\nconst _hoisted_6 = {\n  class: \"chat-name\"\n};\nconst _hoisted_7 = {\n  class: \"chat-last\"\n};\nconst _hoisted_8 = {\n  key: 0,\n  class: \"chat-window\"\n};\nconst _hoisted_9 = {\n  class: \"chat-header\"\n};\nconst _hoisted_10 = {\n  class: \"chat-body\",\n  ref: \"chatBodyRef\"\n};\nconst _hoisted_11 = {\n  class: \"chat-content\"\n};\nconst _hoisted_12 = {\n  class: \"chat-time\"\n};\nconst _hoisted_13 = {\n  class: \"chat-input\"\n};\nconst _hoisted_14 = {\n  key: 1,\n  class: \"chat-window\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_el_avatar = _resolveComponent(\"el-avatar\");\n  const _component_el_badge = _resolveComponent(\"el-badge\");\n  const _component_el_input = _resolveComponent(\"el-input\");\n  const _directive_loading = _resolveDirective(\"loading\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createVNode(_component_el_button, {\n    type: \"primary\",\n    plain: \"\",\n    class: \"back-btn\",\n    onClick: $setup.goBack\n  }, {\n    default: _withCtx(() => _cache[1] || (_cache[1] = [_createTextVNode(\" 返回首页 \")])),\n    _: 1 /* STABLE */\n  }), _createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.chatList, chat => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: chat.targetId,\n      class: _normalizeClass([\"chat-item\", {\n        active: $setup.activeChat && $setup.activeChat.targetId === chat.targetId\n      }]),\n      onClick: $event => $setup.selectChat(chat)\n    }, [_createVNode(_component_el_avatar, {\n      src: chat.user_pic,\n      size: \"large\"\n    }, {\n      default: _withCtx(() => [_createTextVNode(_toDisplayString(chat.nickname ? chat.nickname[0] : '?'), 1 /* TEXT */)]),\n      _: 2 /* DYNAMIC */\n    }, 1032 /* PROPS, DYNAMIC_SLOTS */, [\"src\"]), _createElementVNode(\"div\", _hoisted_5, [_createElementVNode(\"div\", _hoisted_6, _toDisplayString(chat.nickname), 1 /* TEXT */), _createElementVNode(\"div\", _hoisted_7, _toDisplayString(chat.lastMessage), 1 /* TEXT */)]), chat.unReadCount > 0 ? (_openBlock(), _createBlock(_component_el_badge, {\n      key: 0,\n      value: chat.unReadCount\n    }, null, 8 /* PROPS */, [\"value\"])) : _createCommentVNode(\"v-if\", true)], 10 /* CLASS, PROPS */, _hoisted_4);\n  }), 128 /* KEYED_FRAGMENT */))]), $setup.activeChat ? (_openBlock(), _createElementBlock(\"div\", _hoisted_8, [_createElementVNode(\"div\", _hoisted_9, \" 与 \" + _toDisplayString($setup.activeChat.nickname) + \" 的聊天 \", 1 /* TEXT */), _withDirectives((_openBlock(), _createElementBlock(\"div\", _hoisted_10, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.messages, msg => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: msg.message_id,\n      class: _normalizeClass([\"chat-message\", {\n        'me': msg.from_id === $setup.currentUser.user_id\n      }])\n    }, [_createElementVNode(\"div\", _hoisted_11, _toDisplayString(msg.content), 1 /* TEXT */), _createElementVNode(\"div\", _hoisted_12, _toDisplayString(new Date(msg.created_at).toLocaleString()), 1 /* TEXT */)], 2 /* CLASS */);\n  }), 128 /* KEYED_FRAGMENT */))])), [[_directive_loading, $setup.loadingMessages]]), _createElementVNode(\"div\", _hoisted_13, [_createVNode(_component_el_input, {\n    modelValue: $setup.inputMessage,\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $setup.inputMessage = $event),\n    placeholder: \"请输入消息\",\n    onKeyup: _withKeys($setup.sendMsg, [\"enter\"])\n  }, null, 8 /* PROPS */, [\"modelValue\"]), _createVNode(_component_el_button, {\n    type: \"primary\",\n    onClick: $setup.sendMsg\n  }, {\n    default: _withCtx(() => _cache[2] || (_cache[2] = [_createTextVNode(\"发送\")])),\n    _: 1 /* STABLE */\n  })])])) : (_openBlock(), _createElementBlock(\"div\", _hoisted_14, _cache[3] || (_cache[3] = [_createElementVNode(\"div\", {\n    class: \"chat-placeholder\"\n  }, \"请选择一个聊天\", -1 /* HOISTED */)])))])]);\n}","map":{"version":3,"names":["class","key","ref","_createElementBlock","_hoisted_1","_createVNode","_component_el_button","type","plain","onClick","$setup","goBack","default","_withCtx","_cache","_createTextVNode","_","_createElementVNode","_hoisted_2","_hoisted_3","_Fragment","_renderList","chatList","chat","targetId","_normalizeClass","active","activeChat","$event","selectChat","_component_el_avatar","src","user_pic","size","_toDisplayString","nickname","_hoisted_5","_hoisted_6","_hoisted_7","lastMessage","unReadCount","_createBlock","_component_el_badge","value","_createCommentVNode","_hoisted_4","_hoisted_8","_hoisted_9","_hoisted_10","messages","msg","message_id","from_id","currentUser","user_id","_hoisted_11","content","_hoisted_12","Date","created_at","toLocaleString","loadingMessages","_hoisted_13","_component_el_input","modelValue","inputMessage","placeholder","onKeyup","_withKeys","sendMsg","_hoisted_14"],"sources":["C:\\Users\\32561\\Desktop\\毕设仓库\\beauty-front\\src\\views\\Mine\\MyMessage.vue"],"sourcesContent":["<script setup>\r\nimport {ref, onMounted, nextTick} from 'vue'\r\nimport { useRouter } from 'vue-router'\r\nimport {ElMessage} from 'element-plus'\r\nimport {getChatList, getHistory, sendMessage, setMessageRead} from '@/api/prMessage'\r\nimport {userOtherInfoService, userInfoService} from '@/api/user'\r\n\r\nconst chatList = ref([])\r\nconst activeChat = ref(null)\r\nconst messages = ref([])\r\nconst inputMessage = ref('')\r\nconst pageNum = ref(1)\r\nconst pageSize = ref(20)\r\nconst loadingMessages = ref(false)\r\nconst currentUser = ref({})\r\nconst chatBodyRef = ref(null)\r\n\r\nconst router = useRouter()\r\n\r\nconst goBack = () => {\r\n  router.back()\r\n}\r\n\r\n// 获取当前用户信息\r\nconst fetchCurrentUser = async () => {\r\n  try {\r\n    const res = await userInfoService()\r\n    if (res.data.code === 200) {\r\n      currentUser.value = res.data\r\n    }\r\n    console.log(1)\r\n    console.log(currentUser)\r\n  } catch (err) {\r\n    ElMessage.error('获取当前用户信息失败')\r\n  }\r\n}\r\n\r\n// 拉聊天列表\r\nconst fetchChatList = async () => {\r\n  try {\r\n    const res = await getChatList()\r\n    if (res.data.code === 200) {\r\n      const tempList = res.data.data || []\r\n      for (const item of tempList) {\r\n        try {\r\n          const userInfoRes = await userOtherInfoService(item.targetId)\r\n          if (userInfoRes.data.code === 200) {\r\n            item.nickname = userInfoRes.data.data.nickname\r\n            item.user_pic = userInfoRes.data.data.user_pic\r\n          } else {\r\n            item.nickname = '未知用户'\r\n            item.user_pic = ''\r\n          }\r\n        } catch (e) {\r\n          item.nickname = '未知用户'\r\n          item.user_pic = ''\r\n        }\r\n      }\r\n      chatList.value = tempList\r\n      console.log(123)\r\n      console.log(chatList)\r\n    }\r\n  } catch (err) {\r\n    ElMessage.error('获取聊天列表失败')\r\n  }\r\n}\r\n\r\n// 拉取聊天记录\r\nconst fetchMessages = async () => {\r\n  if (!activeChat.value) return\r\n  loadingMessages.value = true\r\n  try {\r\n    const res = await getHistory({\r\n      pageNum: pageNum.value,\r\n      pageSize: pageSize.value,\r\n      target_id: activeChat.value.target_id\r\n    })\r\n    if (res.data.code === 200) {\r\n      messages.value = res.data.data || []\r\n      await nextTick()\r\n      scrollToBottom()\r\n    }\r\n  } catch (err) {\r\n    ElMessage.error('获取消息失败')\r\n  } finally {\r\n    loadingMessages.value = false\r\n  }\r\n}\r\n\r\n// 选择聊天对象\r\nconst selectChat = async (chat) => {\r\n  activeChat.value = chat\r\n  pageNum.value = 1\r\n  await fetchMessages()\r\n  await setMessageRead(chat.targetId)\r\n}\r\n\r\n// 发送消息\r\nconst sendMsg = async () => {\r\n  if (!inputMessage.value.trim() || !activeChat.value) return\r\n  try {\r\n    await sendMessage({\r\n      to_id: activeChat.value.targetId,\r\n      content: inputMessage.value.trim()\r\n    })\r\n    inputMessage.value = ''\r\n    await fetchMessages()\r\n  } catch (err) {\r\n    ElMessage.error('发送失败')\r\n  }\r\n}\r\n\r\n// 自动滚动到底\r\nconst scrollToBottom = () => {\r\n  if (chatBodyRef.value) {\r\n    chatBodyRef.value.scrollTop = chatBodyRef.value.scrollHeight\r\n  }\r\n}\r\n\r\nonMounted(async () => {\r\n  await fetchCurrentUser()\r\n  await fetchChatList()\r\n})\r\n</script>\r\n\r\n<template>\r\n  <div class=\"main-content\">\r\n    <el-button type=\"primary\" plain class=\"back-btn\" @click=\"goBack\">\r\n      返回首页\r\n    </el-button>\r\n    <div class=\"message-page\">\r\n      <div class=\"chat-list\">\r\n        <div\r\n            v-for=\"chat in chatList\"\r\n            :key=\"chat.targetId\"\r\n            class=\"chat-item\"\r\n            :class=\"{ active: activeChat && activeChat.targetId === chat.targetId }\"\r\n            @click=\"selectChat(chat)\"\r\n        >\r\n          <el-avatar :src=\"chat.user_pic\" size=\"large\">{{ chat.nickname ? chat.nickname[0] : '?' }}</el-avatar>\r\n          <div class=\"chat-info\">\r\n            <div class=\"chat-name\">{{ chat.nickname }}</div>\r\n            <div class=\"chat-last\">{{ chat.lastMessage }}</div>\r\n          </div>\r\n          <el-badge :value=\"chat.unReadCount\" v-if=\"chat.unReadCount > 0\"/>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"chat-window\" v-if=\"activeChat\">\r\n        <div class=\"chat-header\">\r\n          与 {{ activeChat.nickname }} 的聊天\r\n        </div>\r\n\r\n        <div class=\"chat-body\" ref=\"chatBodyRef\" v-loading=\"loadingMessages\">\r\n          <div v-for=\"msg in messages\" :key=\"msg.message_id\" class=\"chat-message\"\r\n               :class=\"{ 'me': msg.from_id === currentUser.user_id }\">\r\n            <div class=\"chat-content\">{{ msg.content }}</div>\r\n            <div class=\"chat-time\">{{ new Date(msg.created_at).toLocaleString() }}</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"chat-input\">\r\n          <el-input\r\n              v-model=\"inputMessage\"\r\n              placeholder=\"请输入消息\"\r\n              @keyup.enter=\"sendMsg\"\r\n          />\r\n          <el-button type=\"primary\" @click=\"sendMsg\">发送</el-button>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"chat-window\" v-else>\r\n        <div class=\"chat-placeholder\">请选择一个聊天</div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<style scoped>\r\n.main-content {\r\n  flex: 1;\r\n  width: 1720px;\r\n  margin: 0 auto;\r\n  background: #f5f7fa;\r\n}\r\n.message-page {\r\n  display: flex;\r\n  width: 1720px;\r\n  margin: 0 auto;\r\n  margin-bottom: 10px;\r\n  height: 90vh;\r\n  background: #f5f7fa;\r\n}\r\n\r\n.chat-list {\r\n  width: 300px;\r\n  background: white;\r\n  border-right: 1px solid #ddd;\r\n  overflow-y: auto;\r\n}\r\n\r\n.chat-item {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 15px;\r\n  cursor: pointer;\r\n  border-bottom: 1px solid #eee;\r\n}\r\n\r\n.chat-item.active {\r\n  background: #e6f7ff;\r\n}\r\n\r\n.chat-info {\r\n  margin-left: 10px;\r\n  flex: 1;\r\n}\r\n\r\n.chat-name {\r\n  font-weight: bold;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.chat-last {\r\n  color: #999;\r\n  font-size: 12px;\r\n}\r\n\r\n.chat-window {\r\n  flex: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n\r\n.chat-header {\r\n  background: white;\r\n  padding: 15px;\r\n  border-bottom: 1px solid #ddd;\r\n  font-weight: bold;\r\n}\r\n\r\n.chat-body {\r\n  flex: 1;\r\n  padding: 15px;\r\n  overflow-y: auto;\r\n  background: #f9f9f9;\r\n}\r\n\r\n.chat-message {\r\n  margin-bottom: 10px;\r\n  max-width: 60%;\r\n  word-break: break-word;\r\n}\r\n\r\n.chat-message.me {\r\n  margin-left: auto;\r\n  text-align: right;\r\n}\r\n\r\n.chat-content {\r\n  display: inline-block;\r\n  background: #409eff;\r\n  color: white;\r\n  padding: 10px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.chat-message.me .chat-content {\r\n  background: #67c23a;\r\n}\r\n\r\n.chat-time {\r\n  font-size: 10px;\r\n  color: #999;\r\n  margin-top: 5px;\r\n}\r\n\r\n.chat-input {\r\n  display: flex;\r\n  padding: 15px;\r\n  background: white;\r\n  border-top: 1px solid #ddd;\r\n}\r\n\r\n.chat-placeholder {\r\n  margin: auto;\r\n  font-size: 20px;\r\n  color: #ccc;\r\n}\r\n\r\n.back-btn {\r\n  margin: 5px;\r\n}\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}